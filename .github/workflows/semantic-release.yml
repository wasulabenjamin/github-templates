name: ğŸ·ï¸ Semantic Release              # Workflow name that appears in GitHub Actions UI

concurrency:                           # Prevents multiple runs of the same workflow
  group: ${{ github.workflow }}-${{ github.ref }}     # Defines the grouping key

  # If a new run starts for this same concurrency group, automatically cancel any currently running one.
  cancel-in-progress: true             # Safety & efficiency flag set to true.

on:                                    # Defines the triggers that cause this workflow to run.
  workflow_run:
    workflows: ["ğŸ“¦ Continuous Integration"]
    branches: [main]                   # Only run when CI completed on the main branch
    types: [completed]

permissions:
  contents: write                      # Create releases and attach assets.
  packages: write                      # Publish to GitHub Packages (if used).

env:
  NODE_ENV: production

jobs:                                  # Defines all the major automated tasks GitHub will run

  release:                             # Defines a release job
    if: github.event.workflow_run.conclusion == 'success'  # Only proceed if CI was successful
    name: GitHub Release               # Gives the job a human-readable name which appears in GitHubâ€™s â€œActionsâ€ UI.
    runs-on: ubuntu-latest             # Run this job on the latest Ubuntu Linux virtual machine.
    timeout-minutes: 5                 # Automatically cancel an entire job if it runs longer than set minutes.

    steps:

      # ğŸ“¥ Step 1: Downloads the repositoryâ€™s code into the runner.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0               # Fetch all history and tags (required for semantic versioning)

      # ğŸ“¥ Step 2: Download pre-built artifacts from a previous ci job
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          name: build-output

      # ğŸ” Step 3: Verify build artifacts
      - name: Verify build artifacts
        id: verify
        run: |
          echo "ğŸ” Verifying downloaded artifact..."

          if [ -d dist ]; then
            echo "build_dir=dist" >> $GITHUB_OUTPUT
            echo "âœ… Found dist/ directory."
          elif [ -d build ]; then
            echo "build_dir=build" >> $GITHUB_OUTPUT
            echo "âœ… Found build/ directory."
          elif [ -d out ]; then
            echo "build_dir=out" >> $GITHUB_OUTPUT
            echo "âœ… Found out/ directory."
          else
            echo "âŒ No build output found (expected one of: dist/, build/, out/)."
            exit 1
          fi

      # âš™ï¸ Step 4: Get and Validate the latest semantic tag
      - name: Get and Validate latest semantic tag
        id: get_tag
        run: |
          git fetch --tags
          LATEST_TAG=$(git tag -l "v*" --sort=-version:refname | head -n 1)

          if [ -z "$LATEST_TAG" ]; then
            echo "âŒ No semantic version tag found"
            exit 1
          elif [[ ! $LATEST_TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "âŒ Invalid tag format: $LATEST_TAG"
            echo "ğŸ’¡ Use semantic versioning: v1.0.0, v2.1.3, v1.0.0-beta.1"
            exit 1
          else
            echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "âœ… Found latest tag: $LATEST_TAG"
          fi

      # ğŸ“¦ Step 5: Create a distribution package
      - name: Create distribution package
        run: |
          BUILD_DIR="${{ steps.verify.outputs.build_dir }}"
          echo "ğŸ“¦ Packaging contents from: $BUILD_DIR"

          mkdir -p dist-package

          # Copy the actual build output
          cp -r $BUILD_DIR/* dist-package/ 2>/dev/null || echo "âš ï¸ Could not copy all files from $BUILD_DIR"

          # Copy additional project files if they exist
          echo "ğŸ“„ Adding project metadata..."
          [ -f "README.md" ] && cp README.md dist-package/ && echo "  âœ… README.md" 
          [ -f "LICENSE" ] && cp LICENSE dist-package/ && echo "  âœ… LICENSE"
          [ -f "CHANGELOG.md" ] && cp CHANGELOG.md dist-package/ && echo "  âœ… CHANGELOG.md"

          # Show what we're packaging
          echo "ğŸ“ Final package contents:"
          ls -la dist-package/

          # Create the archive
          tar -czf release-assets.tar.gz dist-package/
          echo "ğŸ“¦ Created release-assets.tar.gz from $BUILD_DIR"

      # ğŸ·ï¸ Step 6: Create GitHub Release (USE ACTUAL TAG)
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: Version ${{ steps.get_tag.outputs.tag }}  # More formal naming
          body: |
            ## What's Changed

            This release includes all changes up to tag ${{ steps.get_tag.outputs.tag }}.

            ### ğŸ“¦ Distribution Package
            - Built assets from ${{ steps.verify.outputs.build_dir }}
            - Includes project metadata (README, LICENSE, CHANGELOG)

            See CHANGELOG.md for detailed release notes.
          #generate_release_notes: true  # GitHub will still auto-generate notes
          draft: false
          prerelease: ${{ contains(steps.get_tag.outputs.tag, '-') }}
          files: release-assets.tar.gz

      # ğŸ§¹ Step 7: Cleanup after you
      - name: Cleanup
        run: rm -f release-assets.tar.gz && rm -rf dist-package/

      # ğŸ§¾ Step 8: Smart summary
      - name: Release workflow summary
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "ğŸ‰ Release ${{ github.ref_name }} published successfully."
            echo "ğŸ“ Release notes: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          elif [[ "${{ job.status }}" == "failure" ]]; then
            echo "âŒ Release job failed"
          else
            echo "âš ï¸ Release job ended with status: ${{ job.status }}"
            exit 1
          fi

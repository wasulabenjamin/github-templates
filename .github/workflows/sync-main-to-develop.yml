name: üîÑ Sync main to develop          # Workflow name that appears in GitHub Actions UI

# IMPORTANT! Allow concurrent runs. DO NOT TRY preventing multiple runs of this workflow

on:
  workflow_run:                        # Trigger 1: When changelog workflow completes (for code changes)
    workflows: ["üìÑ Auto Update Changelog"]
    branches: [main]                   # Only run when changelog completed on the main branch
    types: [completed]
  push:                                # Trigger 2: Direct push to main with doc-only changes
    branches: [main]
    paths:
      - '.github/**'
      - 'docs/**'
      - '**.md'
  workflow_dispatch:                   # Allow for manual trigger if shit gets out of hand

# Although permissions block is no longer needed since we're using app token with explicit permissions
permissions:
  contents: write                      # Required for pushing to `develop` changes from `main`

env:
  GIT_AUTHOR_NAME: "github-actions[bot]"
  GIT_AUTHOR_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
  GIT_COMMITTER_NAME: "Wasula Benjamin (via: üîÑ Sync main to develop)"
  GIT_COMMITTER_EMAIL: "wasulabenjamin@users.noreply.github.com"

jobs:                                  # Defines all the major automated tasks GitHub will run

  merge-main-into-develop:             # Defines a Main to Develop synchronization job
    if: >
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'push') || (github.event_name == 'workflow_dispatch')
    name: Sync main to develop         # Gives the job a human-readable name which appears in GitHub‚Äôs ‚ÄúActions‚Äù UI.
    runs-on: ubuntu-latest             # Run this job on the latest Ubuntu Linux virtual machine.
    timeout-minutes: 2                 # Automatically cancel an entire job if it runs longer than set minutes.

    steps:

      # üîë Step 1: Generate GitHub App token to bypass branch protection
      - name: Generate Changelog App token
        id: changelog-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.CHANGELOG_BOT_ID }}               # Changelog Bot ID
          private_key: ${{ secrets.CHANGELOG_BOT_PRIVATE_KEY }} # Changelog Bot Private Key

      # üì• Step 2: Downloads the repository‚Äôs code into the runner.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.changelog-token.outputs.token }}     # Uses changelog-token instead of GITHUB_TOKEN
          fetch-depth: 0                                        # Full history for accurate changelog

      # üß† Step 3: SMART TRIGGER CHECK - Prevent duplicate runs
      - name: Determine if this is a direct doc-only push
        id: detect
        run: |
          # Case 1: Triggered by workflow_run (changelog completed)
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "‚úÖ Trigger: workflow_run - exiting trigger check"
            echo "is_doc_only=false" >> $GITHUB_OUTPUT

          # Case 2: Triggered by manual dispatch
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "‚úÖ Trigger: workflow_dispatch - exiting trigger check"
            echo "is_doc_only=false" >> $GITHUB_OUTPUT

          # Case 3: Triggered by push - Check for DOC ONLY CHANGES
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            echo "‚úÖ Trigger: push - checking for doc-only changes..."

            # If its the first commit (HEAD~1 does not exist yet)
            if ! git rev-parse HEAD~1 >/dev/null 2>&1; then
              echo "‚ö†Ô∏è First commit detected ‚Äî cannot compare changes"
              echo "is_doc_only=false" >> $GITHUB_OUTPUT

            # Compare the last commit against its parent
            else
              LAST=$(git rev-parse HEAD)
              BEFORE=$(git rev-parse HEAD~1)

              # List all changed files
              ALL_CHANGED_FILES=$(git diff --name-only "$BEFORE" "$LAST")
              echo "Changed files:"
              echo "$ALL_CHANGED_FILES"

              # Identify non-doc files by excluding docs/, .github/, and any *.md files
              NON_DOC_CHANGED_FILES=$(git diff --name-only "$BEFORE" "$LAST" -- . \
                ':!.github/**' \
                ':!docs/**' \
                ':!*.md')

              echo "Non-doc changed files:"
              echo "$NON_DOC_CHANGED_FILES"

              # Set output based on whether there are non-doc changes
              if [ -z "$NON_DOC_CHANGED_FILES" ]; then
                echo "‚úÖ Doc-only changes detected"
                echo "is_doc_only=true" >> $GITHUB_OUTPUT
              else
                echo "‚ö†Ô∏è Mixed or code changes detected"
                echo "is_doc_only=false" >> $GITHUB_OUTPUT
              fi
            fi

          # Case 4: Unknown trigger
          else
            echo "‚ùì Unknown trigger - defaulting to skip"
            echo "is_doc_only=false" >> $GITHUB_OUTPUT
          fi

      # üõë Step 4: Skip workflow if develop branch doesn't exist
      - name: Check if develop branch exists
        id: check-develop
        if: |
          (github.event_name == 'push' && steps.detect.outputs.is_doc_only == 'true') || 
          (github.event_name == 'workflow_run') || (github.event_name == 'workflow_dispatch')
        run: |
          if git ls-remote --heads origin develop | grep -q "refs/heads/develop"; then
            echo "‚úÖ develop branch exists, continuing..."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚ÑπÔ∏è develop branch does not exist ‚Äî skipping workflow"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # üè∑Ô∏è Step 5: Synchronize updated main branch to develop
      - name: Merge main into develop
        if: steps.check-develop.outputs.exists == 'true'
        run: |
          echo "üîÑ Starting main ‚Üí develop sync..."

          # Configure git identity for the merge commit
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"

          # Switch to develop and get latest
          git checkout develop
          git pull origin develop

          # Check if main is already merged (avoid conflicts)
          if git merge-base --is-ancestor origin/main develop; then
            echo "‚úÖ develop is already up-to-date with main"
            echo "status=already-up-to-date" >> $GITHUB_ENV
            exit 0
          fi

          # Perform the merge
          echo "üîÑ Merging main into develop..."
          git merge origin/main --no-ff -m "chore: sync changes from main [skip ci]" || {
            echo "‚ùå Merge failed - possible conflicts detected"
            echo "üí° Manual resolution required"
            echo "status=merge-failed" >> $GITHUB_ENV
            exit 1
          }

          # Push the changes
          echo "üì§ Pushing updated develop branch..."
          git push origin develop

          echo "‚úÖ Successfully synced main ‚Üí develop"
          echo "status=success" >> $GITHUB_ENV
          git log --oneline --graph --decorate -5
        env:
          GITHUB_TOKEN: ${{ steps.changelog-token.outputs.token }}

      # üßæ Step 6: Smart Summary
      - name: Sync Branches workflow summary
        if: always()
        run: |
          echo "## üîÑ Sync Main ‚Üí Develop Summary"
          echo ""
          echo "**Workflow Trigger:** ${{ github.event_name }}"
          echo "**Doc-only push:** ${{ steps.detect.outputs.is_doc_only }}"
          echo "**Develop branch exists:** ${{ steps.check-develop.outputs.exists }}"
          echo "**Job Status:** ${{ job.status }}"
          echo "**Merge Status:** ${{ env.status }}"
          echo ""

          if [[ "${{ steps.check-develop.outputs.exists }}" != "true" ]]; then
            echo "‚ÑπÔ∏è Develop branch does not exist ‚Äî workflow skipped."
          elif [[ "${{ steps.detect.outputs.is_doc_only }}" == "false" && "${{ github.event_name }}" == "push" ]]; then
            echo "‚ö†Ô∏è Mixed changes detected in push ‚Äî sync skipped in favor of workflow_run trigger."
          elif [[ "${{ env.status }}" == "already-up-to-date" ]]; then
            echo "‚úÖ Develop is already up-to-date with main."
          elif [[ "${{ env.status }}" == "success" ]]; then
            echo "‚úÖ Successfully synced main ‚Üí develop."
          elif [[ "${{ env.status }}" == "merge-failed" ]]; then
            echo "‚ùå Merge conflicts detected ‚Äî manual resolution required."
          else
            echo "‚ö†Ô∏è Sync job ended with status: ${{ job.status }}, merge status: ${{ env.status }}"
          fi

name: üß† Auto-Close Issues on Develop   # Workflow name that appears in GitHub Actions UI

# IMPORTANT! Allow concurrent runs. DO NOT TRY preventing multiple runs of this workflow

on:                                    # Trigger when a PR is closed and merged into develop
  pull_request:
    types: [closed]
    branches: [develop]

permissions:
  issues: write                        # Needed to close issues
  contents: read                       # Needed to read repo files (optional)

jobs:                                  # Defines all the major automated tasks GitHub will run

  close-issues:                        # Defines a close-issues job

    if: github.event.pull_request.merged == true  # Only act on merged PRs
    runs-on: ubuntu-latest             # Run this job on the latest Ubuntu Linux virtual machine.
    timeout-minutes: 2                 # Automatically cancel an entire job if it runs longer than set minutes.

    steps:

      # üì• Step 1: Downloads the repository‚Äôs code into the runner.
      - name: Checkout repository
        uses: actions/checkout@v4

      # üñ•Ô∏è Step 2. Avoid shell interpretation of the PR body content
      - name: Write PR body safely (env + base64)
        run: echo "$PR_BODY" > pr_body.txt
        env:
          PR_BODY: ${{ github.event.pull_request.body }}

      # üì§ Step 3. Extract issue references from PR Description
      - name: Extract issue references from file
        id: extract
        run: |
          # Case Insensitive Regex, matches: "Closes #123", "closes #123", "fixes #22", "resolves #9"
          # It also extracts the number(s) and handles various whitespace
          issues=$(grep -iEo '(^|\b)(close[sd]?|closing|fix(es|ed)?|fixing|resolve[sd]?|resolving)[[:space:]]*#[0-9]+' pr_body.txt \
            | grep -oE '#[0-9]+' \
            | tr -d '#' \
            | sort -u \
            | tr '\n' ' ' \
            | sed 's/ $//')

          if [ -z "$issues" ]; then
            echo "‚ÑπÔ∏è No linked issues found in PR description"
            echo "no_issues=true" >> $GITHUB_OUTPUT
          else
            echo "üö© Linked issues found in PR description"
            echo "no_issues=false" >> $GITHUB_OUTPUT
            echo "issues=$issues" >> $GITHUB_OUTPUT
          fi

      # üìï Step 4: Closes existing issues
      - name: Close issues
        if: steps.extract.outputs.no_issues == 'false'
        run: |
          repo="${{ github.repository }}"

          for issue in ${{ steps.extract.outputs.issues }}; do
            echo "üîç Validating if issue #$issue exists in $repo ..."
            if gh issue view "$issue" >/dev/null 2>&1; then
              echo "üîí Closing issue #$issue..."
              gh issue close $issue --comment \
                "Automatically closed by workflow after PR #${{ github.event.pull_request.number }} was merged into develop."
              echo "‚úÖ Successfully closed issue #$issue"
            else
              echo "‚ö†Ô∏è Issue #$issue not found in $repo - skipping"
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # üßæ Step 5: Smart summary
      - name: Lint workflow summary
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "‚úÖ Auto-Close Issues on Develop job completed successfully."
          elif [[ "${{ job.status }}" == "failure" ]]; then
            echo "‚ùå Auto-Close Issues on Develop job failed"
          else
            echo "‚ö†Ô∏è Auto-Close Issues on Develop job ended with status: ${{ job.status }}"
            exit 1
          fi
